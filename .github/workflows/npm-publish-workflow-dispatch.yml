#
name: Create and publish a NPM Package. Then build release assets if major/minor release

# This workflow publishes the  npm package (can be run manually with workflow_dispatch).
# If the published version has a patch number of 0 (major or minor release), the workflow
# also builds and uploads release assets.
on:
  workflow_dispatch:
    inputs:
      version_number:
        description: Version number <patch|minor| version number(E.g. 1.0.0) see npm version> An empty version number doesn't change the version
        default: ''
      job:
        type: choice
        description: Select job to execute
        options:
          - npm_publish
          - docker
          - all
        default: 'all'

# Defines two custom environment variables for the workflow. These are used for the Container registry domain, and a name for the Docker image that this workflow builds.
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: modbus2mqtt/lxc-manager

# There is a single job in this workflow. It's configured to run on the latest available version of Ubuntu.
jobs:
  npm_publish:
    if: ${{ ( (inputs.job == 'npm_publish')|| (inputs.job == 'all') ) && ( inputs.version_number != '' )}}
    environment: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    outputs:
      tag: ${{steps.set-tag.outputs.tag}}
      version: ${{steps.set-tag.outputs.version}}
      change_log: ${{steps.store_changelog.outputs.change_log}}
      release_exists: ${{steps.set-tag.outputs.release_exists}}
      isRelease: ${{steps.set-tag.outputs.isRelease}}
    steps:
      - name: 'Checkout'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: set package version number for update NPM version
        id: set-tag
        run: |
          set -e
          git config --global user.email "noreply@carcam360.de" 
          git config --global user.name "Workflow User"
          version="$(npm version ${{ inputs.version_number }} | sed -e 's/^v//g' )"
          echo "tag=v$version" >>$GITHUB_OUTPUT
          echo "version=$version" >>$GITHUB_OUTPUT
          echo "tag=v$version" 
          git push
          minor=$(echo $version| sed -e 's/\([0-9]*\)\.\([0-9]*\)\..*/\2/g')
          major=$(echo $version| sed -e 's/\([0-9]*\)\.\([0-9]*\)\..*/\1/g')
          echo minor $minor
          echo major $major
          if [[ "$version" =~ \.0$ ]]; then  
            since="v$major.$(expr $minor - 1)"  
            echo "isRelease=true" >>$GITHUB_OUTPUT 
          else
            since="v$major.$minor" 
            echo "isRelease=" >>$GITHUB_OUTPUT 
          fi
          since_tag=$(git tag| grep "$since"| sort -n| head -1)
          echo since_tag=$since_tag >>$GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'
          registry-url: 'https://registry.npmjs.org'
          always-auth: true
          token: ${{ secrets.NPMJS }}

      - name: Scope npm package for forks
        if: ${{ github.repository_owner != 'modbus2mqtt' }}
        env:
          REPO_OWNER: ${{ github.repository_owner }}
        run: |
          set -euo pipefail
          echo "Repository owner is '$REPO_OWNER' â€” scoping package name to avoid overwriting upstream package"
          python3 - <<'PY'
          import json, os
          path = 'package.json'
          data = json.load(open(path))
          orig = data.get('name','')
          scoped = f"@{os.environ['REPO_OWNER']}/lxc-manager"
          data['name'] = scoped
          open(path,'w').write(json.dumps(data, indent=2) + '\n')
          print(f"package.json name updated: {orig} -> {scoped}")
          PY

      - name: NPM run build and publish
        id: npmbuildpublish
        run: |
          npm ci 
          echo "::group::Building project frontend ..."
          (cd frontend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building backend  ..."
          (cd backend  && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building root  ..."
          (npm ci && npm run build)
          echo "::endgroup::"          
          echo "::group::Publishing to NPM registry ..."  
          npm set registry https://registry.npmjs.org/
          npm publish --access public
          echo "::endgroup::"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPMJS }}
  docker_image:
    if: ${{ inputs.job == 'all' }}
    needs: npm_publish
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout release tag
        run: |
          git fetch --tags
          git checkout ${{ needs.npm_publish.outputs.tag }}

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Build project and create npm pack tarball
        id: pack
        run: |
          set -euo pipefail
          npm ci
          echo "::group::Building project frontend ..."
          (cd frontend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building backend  ..."
          (cd backend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building root  ..."
          (npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Packing npm tarball ..."
          info=$(npm pack --json)
          tarball=$(node -e "const i=JSON.parse(process.env.INFO); console.log(i[0].filename)" INFO="$info")
          version=$(node -e "const i=JSON.parse(process.env.INFO); console.log(i[0].version)" INFO="$info")
          mv "$tarball" docker/lxc-manager.tgz
          echo "tarball=docker/lxc-manager.tgz" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image from npm pack
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.npm-pack
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:${{ steps.pack.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:latest
          build-args: |
            NPM_TARBALL=${{ steps.pack.outputs.tarball }}
            BUILD_VERSION=${{ steps.pack.outputs.version }}
            BUILD_REF=${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}
            BUILD_REPOSITORY=${{ github.repository }}

  docker_image_only:
    if: ${{ inputs.job == 'docker' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set version (docker only)
        id: set-version
        run: |
          set -euo pipefail
          git config --global user.email "noreply@carcam360.de" 
          git config --global user.name "Workflow User"
          if [ -n "${{ inputs.version_number }}" ]; then
            version="$(npm version ${{ inputs.version_number }} | sed -e 's/^v//g' )"
            git push
          else
            version="$(node -p "require('./package.json').version")"
          fi
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version-file: '.nvmrc'

      - name: Build project and create npm pack tarball
        id: pack_only
        run: |
          set -euo pipefail
          npm ci
          echo "::group::Building project frontend ..."
          (cd frontend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building backend  ..."
          (cd backend && npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Building root  ..."
          (npm ci && npm run build)
          echo "::endgroup::"
          echo "::group::Packing npm tarball ..."
          info=$(npm pack --json)
          tarball=$(node -e "const i=JSON.parse(process.env.INFO); console.log(i[0].filename)" INFO="$info")
          mv "$tarball" docker/lxc-manager.tgz
          echo "tarball=docker/lxc-manager.tgz" >> $GITHUB_OUTPUT
          echo "::endgroup::"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image from npm pack
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.npm-pack
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:${{ steps.set-version.outputs.version }}
            ${{ env.REGISTRY }}/${{ github.repository_owner }}/lxc-manager:latest
          build-args: |
            NPM_TARBALL=${{ steps.pack_only.outputs.tarball }}
            BUILD_VERSION=${{ steps.set-version.outputs.version }}
            BUILD_REF=${{ github.sha }}
            BUILD_DATE=${{ github.run_started_at }}
            BUILD_REPOSITORY=${{ github.repository }}
  build_assets:
    if: ${{ needs.npm_publish.outputs.isRelease != '' }}
    permissions:
      packages: write
      contents: write
    needs: npm_publish
    uses: ./.github/workflows/release-assets.yml
    with:
      version: ${{ needs.npm_publish.outputs.version }}
