#!/bin/sh
# Pre-push hook to sync with upstream and update main branch before pushing
# This hook runs before every git push to ensure the local repository is up-to-date
# with the upstream (GitHub) repository and that the current branch is based on the latest main.
#
# Requirements:
#   - gh (GitHub CLI) must be installed and authenticated
#   - git must be available
#
# Behavior:
#   1. Syncs the GitHub fork with the upstream repository (if configured)
#   2. Fetches latest changes from origin
#   3. Updates local main branch to match origin/main (fast-forward only)
#   4. Merges main into the current branch
#   5. Aborts and exits with error if merge conflicts occur
#
# To skip this hook temporarily: git push --no-verify

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

echo "${BLUE}==> Pre-push hook started${NC}"
echo "${BLUE}==> Current branch: ${CURRENT_BRANCH}${NC}"

# Check if gh is installed
if ! command -v gh >/dev/null 2>&1; then
  echo "${YELLOW}Warning: GitHub CLI (gh) is not installed. Skipping upstream sync.${NC}"
  echo "${YELLOW}Install gh from: https://cli.github.com/${NC}"
else
  # Sync fork with upstream (if this is a fork)
  echo "${BLUE}==> Syncing GitHub repository with upstream...${NC}"
  if gh repo sync --force 2>/dev/null; then
    echo "${GREEN}✓ GitHub repository synced with upstream${NC}"
  else
    # Not a fork or no upstream configured - this is okay
    echo "${YELLOW}Note: No upstream sync performed (not a fork or no upstream configured)${NC}"
  fi
fi

# Fetch latest changes from origin
echo "${BLUE}==> Fetching latest changes from origin...${NC}"
if ! git fetch origin; then
  echo "${RED}Error: Failed to fetch from origin${NC}"
  exit 1
fi
echo "${GREEN}✓ Fetched latest changes${NC}"

# Save current state
ORIGINAL_BRANCH="$CURRENT_BRANCH"
STASH_NEEDED=0

# Check if there are uncommitted changes
if ! git diff-index --quiet HEAD --; then
  echo "${YELLOW}Stashing uncommitted changes...${NC}"
  git stash push -m "pre-push hook stash" --include-untracked
  STASH_NEEDED=1
fi

# Function to restore state and exit
cleanup_and_exit() {
  EXIT_CODE=$1
  if [ "$STASH_NEEDED" -eq 1 ]; then
    echo "${BLUE}==> Restoring stashed changes...${NC}"
    git stash pop
  fi
  exit "$EXIT_CODE"
}

# Update main branch if it exists
if git show-ref --verify --quiet refs/heads/main; then
  MAIN_BRANCH="main"
elif git show-ref --verify --quiet refs/heads/master; then
  MAIN_BRANCH="master"
else
  echo "${YELLOW}Warning: Neither main nor master branch found. Skipping main branch update.${NC}"
  cleanup_and_exit 0
fi

echo "${BLUE}==> Updating ${MAIN_BRANCH} branch...${NC}"

# Switch to main branch
if ! git checkout "$MAIN_BRANCH" -q; then
  echo "${RED}Error: Failed to checkout ${MAIN_BRANCH} branch${NC}"
  cleanup_and_exit 1
fi

# Update main branch (fast-forward only)
if git merge --ff-only "origin/${MAIN_BRANCH}"; then
  echo "${GREEN}✓ ${MAIN_BRANCH} branch updated${NC}"
else
  echo "${RED}Error: Cannot fast-forward ${MAIN_BRANCH} branch${NC}"
  echo "${RED}Please resolve manually: git checkout ${MAIN_BRANCH} && git merge origin/${MAIN_BRANCH}${NC}"
  git checkout "$ORIGINAL_BRANCH" -q
  cleanup_and_exit 1
fi

# Return to original branch if not on main
if [ "$ORIGINAL_BRANCH" != "$MAIN_BRANCH" ]; then
  echo "${BLUE}==> Returning to ${ORIGINAL_BRANCH} branch...${NC}"
  if ! git checkout "$ORIGINAL_BRANCH" -q; then
    echo "${RED}Error: Failed to checkout ${ORIGINAL_BRANCH} branch${NC}"
    cleanup_and_exit 1
  fi
  
  echo "${BLUE}==> Merging ${MAIN_BRANCH} into ${ORIGINAL_BRANCH}...${NC}"
  
  # Try to merge main into current branch
  if git merge "$MAIN_BRANCH" --no-edit; then
    echo "${GREEN}✓ Successfully merged ${MAIN_BRANCH} into ${ORIGINAL_BRANCH}${NC}"
  else
    # Merge conflict detected
    echo "${RED}========================================${NC}"
    echo "${RED}ERROR: Merge conflict detected!${NC}"
    echo "${RED}========================================${NC}"
    echo "${RED}Cannot automatically merge ${MAIN_BRANCH} into ${ORIGINAL_BRANCH} due to conflicts.${NC}"
    echo ""
    echo "${YELLOW}The merge has been started but not completed.${NC}"
    echo "${YELLOW}Please resolve the conflicts now, or abort the merge.${NC}"
    echo ""
    echo "${YELLOW}To resolve and continue:${NC}"
    echo "  1. Fix conflicts in your editor"
    echo "  2. Stage resolved files: git add <files>"
    echo "  3. Complete merge: git commit"
    echo "  4. Try pushing again: git push"
    echo ""
    echo "${YELLOW}To abort the merge:${NC}"
    echo "  git merge --abort"
    echo ""
    
    # Don't abort automatically - let user decide
    cleanup_and_exit 1
  fi
fi

# Restore stashed changes if any
if [ "$STASH_NEEDED" -eq 1 ]; then
  echo "${BLUE}==> Restoring stashed changes...${NC}"
  if git stash pop; then
    echo "${GREEN}✓ Stashed changes restored${NC}"
  else
    echo "${RED}Error: Failed to restore stashed changes${NC}"
    echo "${YELLOW}Run 'git stash pop' manually after resolving any issues${NC}"
    exit 1
  fi
fi

echo "${GREEN}========================================${NC}"
echo "${GREEN}✓ Pre-push checks passed successfully${NC}"
echo "${GREEN}========================================${NC}"
echo ""

exit 0
